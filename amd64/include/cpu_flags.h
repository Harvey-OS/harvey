/*
 * This file is part of the Harvey operating system.  It is subject to the
 * license terms of the GNU GPL v2 in LICENSE.gpl found in the top-level
 * directory of this distribution and at http://www.gnu.org/licenses/gpl-2.0.txt
 *
 * No part of Harvey operating system, including this file, may be copied,
 * modified, propagated, or distributed except according to the terms
 * contained in the LICENSE.gpl file.
 */

typedef struct Cpuflag {
	const char	*name;		/* short name (linux-like)*/
	uint32_t	eax;		/* input eax */
	uint8_t		infoidx;	/* index of info result */
	uint8_t		bitidx;		/* feature bit in info result */
} Cpuflag;

typedef enum CPUID_EAX {
	CPUID_EAX_0x00000000	= 0x00000000,
	CPUID_EAX_0x00000001	= 0x00000001,
	CPUID_EAX_0x00000006	= 0x00000006,
	CPUID_EAX_0x00000007	= 0x00000007,
	CPUID_EAX_0x0000000d	= 0x0000000d,
	CPUID_EAX_0x0000000f	= 0x0000000f,
	CPUID_EAX_0x80000000	= 0x80000000,
	CPUID_EAX_0x80000001	= 0x80000001,
	CPUID_EAX_0x80000002	= 0x80000002,
	CPUID_EAX_0x80000003	= 0x80000003,
	CPUID_EAX_0x80000004	= 0x80000004,
	CPUID_EAX_0x80000007	= 0x00000007,
} CPUID_EAX;

// Below infoidxs equate to: 0=eax 1=ebx 2=ecx 3=edx 
Cpuflag cpuflags[] = {
	/* name				eax 			info 	bit */
	{ "fpu",			CPUID_EAX_0x00000001,	3,	0, },
	{ "vme",			CPUID_EAX_0x00000001,	3,	1, },
	{ "de",				CPUID_EAX_0x00000001,	3,	2, },
	{ "pse",			CPUID_EAX_0x00000001,	3,	3, },
	{ "tsc",			CPUID_EAX_0x00000001,	3,	4, },
	{ "msr",			CPUID_EAX_0x00000001,	3,	5, },
	{ "pae",			CPUID_EAX_0x00000001,	3,	6, },
	{ "mce",			CPUID_EAX_0x00000001,	3,	7, },
	{ "cx8",			CPUID_EAX_0x00000001,	3,	8, },
	{ "apic",			CPUID_EAX_0x00000001,	3,	9, },
	{ "sep",			CPUID_EAX_0x00000001,	3,	11, },
	{ "mtrr",			CPUID_EAX_0x00000001,	3,	12, },
	{ "pge",			CPUID_EAX_0x00000001,	3,	13, },
	{ "mca",			CPUID_EAX_0x00000001,	3,	14, },
	{ "cmov",			CPUID_EAX_0x00000001,	3,	15, },
	{ "pat",			CPUID_EAX_0x00000001,	3,	16, },
	{ "pse36",			CPUID_EAX_0x00000001,	3,	17, },
	{ "pn",				CPUID_EAX_0x00000001,	3,	18, },
	{ "clflush",			CPUID_EAX_0x00000001,	3,	19, },
	{ "dts",			CPUID_EAX_0x00000001,	3,	21, },
	{ "acpi",			CPUID_EAX_0x00000001,	3,	22, },
	{ "mmx",			CPUID_EAX_0x00000001,	3,	23, },
	{ "fxsr",			CPUID_EAX_0x00000001,	3,	24, },
	{ "sse",			CPUID_EAX_0x00000001,	3,	25, },
	{ "sse2",			CPUID_EAX_0x00000001,	3,	26, },
	{ "ss",				CPUID_EAX_0x00000001,	3,	27, },
	{ "ht",				CPUID_EAX_0x00000001,	3,	28, },
	{ "tm",				CPUID_EAX_0x00000001,	3,	29, },
	{ "ia64",			CPUID_EAX_0x00000001,	3,	30, },
	{ "pbe",			CPUID_EAX_0x00000001,	3,	31, },
	//{ "syscall",			CPUID_EAX_0x80000001,	32+11, },
	//{ "mp",				CPUID_EAX_0x80000001,	32+19, },
	//{ "nx",				CPUID_EAX_0x80000001,	32+20, },
	//{ "mmxext",			CPUID_EAX_0x80000001,	32+22, },
	//{ "fxsr_opt",			CPUID_EAX_0x80000001,	32+25, },
	//{ "gbpages",			CPUID_EAX_0x80000001,	32+26, },
	//{ "rdtscp",			CPUID_EAX_0x80000001,	32+27, },
	//{ "lm",				CPUID_EAX_0x80000001,	32+29, },
	//{ "3dnowext",			CPUID_EAX_0x80000001,	32+30, },
	//{ "3dnow",			CPUID_EAX_0x80000001,	32+31, },
	//{ "recovery",			2*32+ 0, },
	//{ "longrun",			2*32+ 1, },
	//{ "lrti",			2*32+ 3, },
	//{ "cxmmx",			3*32+ 0, },
	//{ "k6_mtrr",			3*32+ 1, },
	//{ "cyrix_arr",			3*32+ 2, },
	//{ "centaur_mcr",		3*32+ 3, },
	//{ "k8",				3*32+ 4, },
	//{ "k7",				3*32+ 5, },
	//{ "p3",				3*32+ 6, },
	//{ "p4",				3*32+ 7, },
	//{ "constant_tsc",		3*32+ 8, },
	//{ "up",				3*32+ 9, },
	//{ "art",			3*32+10, },
	//{ "arch_perfmon",		3*32+11, },
	//{ "pebs",			3*32+12, },
	//{ "bts",			3*32+13, },
	//{ "syscall32",			3*32+14, },
	//{ "sysenter32",			3*32+15, },
	//{ "rep_good",			3*32+16, },
	//{ "mfence_rdtsc",		3*32+17, },
	//{ "lfence_rdtsc",		3*32+18, },
	//{ "acc_power",			3*32+19, },
	//{ "nopl",			3*32+20, },
	//{ "always",			3*32+21, },
	//{ "xtopology",			3*32+22, },
	//{ "tsc_reliable",		3*32+23, },
	//{ "nonstop_tsc",		3*32+24, },
	//{ "cpuid",			3*32+25, },
	//{ "extd_apicid",		3*32+26, },
	//{ "amd_dcm",			3*32+27, },
	//{ "aperfmperf",			3*32+28, },
	//{ "nonstop_tsc_s3",		3*32+30, },
	//{ "tsc_known_freq",		3*32+31, },
	{ "pni",			CPUID_EAX_0x00000001,	2,	0, },
	{ "pclmulqdq",			CPUID_EAX_0x00000001,	2,	1, },
	{ "dtes64",			CPUID_EAX_0x00000001,	2,	2, },
	{ "monitor",			CPUID_EAX_0x00000001,	2,	3, },
	{ "ds_cpl",			CPUID_EAX_0x00000001,	2,	4, },
	{ "vmx",			CPUID_EAX_0x00000001,	2,	5, },
	{ "smx",			CPUID_EAX_0x00000001,	2,	6, },
	{ "est",			CPUID_EAX_0x00000001,	2,	7, },
	{ "tm2",			CPUID_EAX_0x00000001,	2,	8, },
	{ "ssse3",			CPUID_EAX_0x00000001,	2,	9, },
	{ "cid",			CPUID_EAX_0x00000001,	2,	10, },
	{ "sdbg",			CPUID_EAX_0x00000001,	2,	11, },
	{ "fma",			CPUID_EAX_0x00000001,	2,	12, },
	{ "cx16",			CPUID_EAX_0x00000001,	2,	13, },
	{ "xtpr",			CPUID_EAX_0x00000001,	2,	14, },
	{ "pdcm",			CPUID_EAX_0x00000001,	2,	15, },
	{ "pcid",			CPUID_EAX_0x00000001,	2,	17, },
	{ "dca",			CPUID_EAX_0x00000001,	2,	18, },
	{ "sse4_1",			CPUID_EAX_0x00000001,	2,	19, },
	{ "sse4_2",			CPUID_EAX_0x00000001,	2,	20, },
	{ "x2apic",			CPUID_EAX_0x00000001,	2,	21, },
	{ "movbe",			CPUID_EAX_0x00000001,	2,	22, },
	{ "popcnt",			CPUID_EAX_0x00000001,	2,	23, },
	{ "tsc_deadline_timer",		CPUID_EAX_0x00000001,	2,	24, },
	{ "aes",			CPUID_EAX_0x00000001,	2,	25, },
	{ "xsave",			CPUID_EAX_0x00000001,	2,	26, },
	{ "osxsave",			CPUID_EAX_0x00000001,	2,	27, },
	{ "avx",			CPUID_EAX_0x00000001,	2,	28, },
	{ "f16c",			CPUID_EAX_0x00000001,	2,	29, },
	{ "rdrand",			CPUID_EAX_0x00000001,	2,	30, },
	{ "hypervisor",			CPUID_EAX_0x00000001,	2,	31, },
	//{ "xstore",			5*32+ 2, },
	//{ "xstore_en",			5*32+ 3, },
	//{ "xcrypt",			5*32+ 6, },
	//{ "xcrypt_en",			5*32+ 7, },
	//{ "ace2",			5*32+ 8, },
	//{ "ace2_en",			5*32+ 9, },
	//{ "phe",			5*32+10, },
	//{ "phe_en",			5*32+11, },
	//{ "pmm",			5*32+12, },
	//{ "pmm_en",			5*32+13, },
	{ "lahf_lm",			CPUID_EAX_0x80000001,	2,	0, },
	{ "cmp_legacy",			CPUID_EAX_0x80000001,	2,	1, },
	{ "svm",			CPUID_EAX_0x80000001,	2,	2, },
	{ "extapic",			CPUID_EAX_0x80000001,	2,	3, },
	{ "cr8_legacy",			CPUID_EAX_0x80000001,	2,	4, },
	{ "abm",			CPUID_EAX_0x80000001,	2,	5, },
	{ "sse4a",			CPUID_EAX_0x80000001,	2,	6, },
	{ "misalignsse",		CPUID_EAX_0x80000001,	2,	7, },
	{ "3dnowprefetch",		CPUID_EAX_0x80000001,	2,	8, },
	{ "osvw",			CPUID_EAX_0x80000001,	2,	9, },
	{ "ibs",			CPUID_EAX_0x80000001,	2,	10, },
	{ "xop",			CPUID_EAX_0x80000001,	2,	11, },
	{ "skinit",			CPUID_EAX_0x80000001,	2,	12, },
	{ "wdt",			CPUID_EAX_0x80000001,	2,	13, },
	{ "lwp",			CPUID_EAX_0x80000001,	2,	15, },
	{ "fma4",			CPUID_EAX_0x80000001,	2,	16, },
	{ "tce",			CPUID_EAX_0x80000001,	2,	17, },
	{ "nodeid_msr",			CPUID_EAX_0x80000001,	2,	19, },
	{ "tbm",			CPUID_EAX_0x80000001,	2,	21, },
	{ "topoext",			CPUID_EAX_0x80000001,	2,	22, },
	{ "perfctr_core",		CPUID_EAX_0x80000001,	2,	23, },
	{ "perfctr_nb",			CPUID_EAX_0x80000001,	2,	24, },
	{ "bpext",			CPUID_EAX_0x80000001,	2,	26, },
	{ "ptsc",			CPUID_EAX_0x80000001,	2,	27, },
	{ "perfctr_llc",		CPUID_EAX_0x80000001,	2,	28, },
	{ "mwaitx",			CPUID_EAX_0x80000001,	2,	29, },
	//{ "ring3mwait",			7*32+ 0, },
	//{ "cpuid_fault",		7*32+ 1, },
	//{ "cpb",			7*32+ 2, },
	//{ "epb",			7*32+ 3, },
	//{ "cat_l3",			7*32+ 4, },
	//{ "cat_l2",			7*32+ 5, },
	//{ "cdp_l3",			7*32+ 6, },
	//{ "invpcid_single",		7*32+ 7, },
	//{ "hw_pstate",			7*32+ 8, },
	//{ "proc_feedback",		7*32+ 9, },
	//{ "sme",			7*32+10, },
	//{ "pti",			7*32+11, },
	//{ "retpoline",			7*32+12, },
	//{ "retpoline_amd",		7*32+13, },
	//{ "intel_ppin",			7*32+14, },
	//{ "cdp_l2",			7*32+15, },
	//{ "msr_spec_ctrl",		7*32+16, },
	//{ "ssbd",			7*32+17, },
	//{ "mba",			7*32+18, },
	//{ "rsb_ctxsw",			7*32+19, },
	//{ "sev",			7*32+20, },
	//{ "use_ibpb",			7*32+21, },
	//{ "use_ibrs_fw",		7*32+22, },
	//{ "spec_store_bypass_disable",	7*32+23, },
	//{ "ls_cfg_ssbd",		7*32+24, },
	//{ "ibrs",			7*32+25, },
	//{ "ibpb",			7*32+26, },
	//{ "stibp",			7*32+27, },
	//{ "zen",			7*32+28, },
	//{ "l1tf_pteinv",		7*32+29, },
	//{ "ibrs_enhanced",		7*32+30, },
	//{ "tpr_shadow",			CPUID_EAX_0x00000007,	8*32+ 0, },
	//{ "vnmi",			CPUID_EAX_0x00000007,	8*32+ 1, },
	//{ "flexpriority",		CPUID_EAX_0x00000007,	8*32+ 2, },
	//{ "ept",			CPUID_EAX_0x00000007,	8*32+ 3, },
	//{ "vpid",			CPUID_EAX_0x00000007,	8*32+ 4, },
	//{ "vmmcall",			CPUID_EAX_0x00000007,	8*32+15, },
	//{ "xenpv",			CPUID_EAX_0x00000007,	8*32+16, },
	//{ "ept_ad",			CPUID_EAX_0x00000007,	8*32+17, },
	{ "fsgsbase",			CPUID_EAX_0x00000007,	1,	0, },
	{ "tsc_adjust",			CPUID_EAX_0x00000007,	1,	1, },
	{ "bmi1",			CPUID_EAX_0x00000007,	1,	3, },
	{ "hle",			CPUID_EAX_0x00000007,	1,	4, },
	{ "avx2",			CPUID_EAX_0x00000007,	1,	5, },
	{ "smep",			CPUID_EAX_0x00000007,	1,	7, },
	{ "bmi2",			CPUID_EAX_0x00000007,	1,	8, },
	{ "erms",			CPUID_EAX_0x00000007,	1,	9, },
	{ "invpcid",			CPUID_EAX_0x00000007,	1,	10, },
	{ "rtm",			CPUID_EAX_0x00000007,	1,	11, },
	{ "cqm",			CPUID_EAX_0x00000007,	1,	12, },
	{ "mpx",			CPUID_EAX_0x00000007,	1,	14, },
	{ "rdt_a",			CPUID_EAX_0x00000007,	1,	15, },
	{ "avx512f",			CPUID_EAX_0x00000007,	1,	16, },
	{ "avx512dq",			CPUID_EAX_0x00000007,	1,	17, },
	{ "rdseed",			CPUID_EAX_0x00000007,	1,	18, },
	{ "adx",			CPUID_EAX_0x00000007,	1,	19, },
	{ "smap",			CPUID_EAX_0x00000007,	1,	20, },
	{ "avx512ifma",			CPUID_EAX_0x00000007,	1,	21, },
	{ "clflushopt",			CPUID_EAX_0x00000007,	1,	23, },
	{ "clwb",			CPUID_EAX_0x00000007,	1,	24, },
	{ "intel_pt",			CPUID_EAX_0x00000007,	1,	25, },
	{ "avx512pf",			CPUID_EAX_0x00000007,	1,	26, },
	{ "avx512er",			CPUID_EAX_0x00000007,	1,	27, },
	{ "avx512cd",			CPUID_EAX_0x00000007,	1,	28, },
	{ "sha_ni",			CPUID_EAX_0x00000007,	1,	29, },
	{ "avx512bw",			CPUID_EAX_0x00000007,	1,	30, },
	{ "avx512vl",			CPUID_EAX_0x00000007,	1,	31, },
	{ "xsaveopt",			CPUID_EAX_0x0000000d,	0,	0, },
	{ "xsavec",			CPUID_EAX_0x0000000d,	0,	1, },
	{ "xgetbv1",			CPUID_EAX_0x0000000d,	0,	2, },
	{ "xsaves",			CPUID_EAX_0x0000000d,	0,	3, },
	{ "cqm_llc",			CPUID_EAX_0x0000000f,	3,	1, },
	{ "cqm_occup_llc",		CPUID_EAX_0x0000000f,	3,	0, },
	{ "cqm_mbm_total",		CPUID_EAX_0x0000000f,	3,	1, },
	{ "cqm_mbm_local",		CPUID_EAX_0x0000000f,	3,	2, },
	//{ "clzero",			CPUID_EAX_0x80000008,	1,	0, },
	//{ "irperf",			CPUID_EAX_0x80000008,	1,	1, },
	//{ "xsaveerptr",			CPUID_EAX_0x80000008,	1,	2, },
	//{ "wbnoinvd",			CPUID_EAX_0x80000008,	1,	9, },
	//{ "amd_ibpb",			CPUID_EAX_0x80000008,	1,	12, },
	//{ "amd_ibrs",			CPUID_EAX_0x80000008,	1,	14, },
	//{ "amd_stibp",			CPUID_EAX_0x80000008,	1,	15, },
	//{ "amd_stibp_always_on",	CPUID_EAX_0x80000008,	1,	17, },
	//{ "amd_ssbd",			CPUID_EAX_0x80000008,	1,	24, },
	//{ "virt_ssbd",			CPUID_EAX_0x80000008,	1,	25, },
	//{ "amd_ssb_no",			CPUID_EAX_0x80000008,	1,	26, },
	{ "dtherm",			CPUID_EAX_0x00000006,	1,	0, },
	{ "ida",			CPUID_EAX_0x00000006,	1,	1, },
	{ "arat",			CPUID_EAX_0x00000006,	1,	2, },
	{ "pln",			CPUID_EAX_0x00000006,	1,	4, },
	{ "pts",			CPUID_EAX_0x00000006,	1,	6, },
	{ "hwp",			CPUID_EAX_0x00000006,	1,	7, },
	{ "hwp_notify",			CPUID_EAX_0x00000006,	1,	8, },
	{ "hwp_act_window",		CPUID_EAX_0x00000006,	1,	9, },
	{ "hwp_epp",			CPUID_EAX_0x00000006,	1,	10, },
	{ "hwp_pkg_req",		CPUID_EAX_0x00000006,	1,	11, },
	//{ "npt",			CPUID_EAX_0x8000000a,	3,	0, },
	//{ "lbrv",			CPUID_EAX_0x8000000a,	3,	1, },
	//{ "svm_lock",			CPUID_EAX_0x8000000a,	3,	2, },
	//{ "nrip_save",		CPUID_EAX_0x8000000a,	3,	3, },
	//{ "tsc_scale",		CPUID_EAX_0x8000000a,	3,	4, },
	//{ "vmcb_clean",		CPUID_EAX_0x8000000a,	3,	5, },
	//{ "flushbyasid",		CPUID_EAX_0x8000000a,	3,	6, },
	//{ "decodeassists",		CPUID_EAX_0x8000000a,	3,	7, },
	//{ "pausefilter",		CPUID_EAX_0x8000000a,	3,	10, },
	//{ "pfthreshold",		CPUID_EAX_0x8000000a,	3,	12, },
	//{ "avic",			CPUID_EAX_0x8000000a,	3,	13, },
	//{ "v_vmsave_vmload",		CPUID_EAX_0x8000000a,	3,	15, },
	//{ "vgif",			CPUID_EAX_0x8000000a,	3,	16, },
	{ "avx512vbmi",			CPUID_EAX_0x00000007,	2,	1, },
	{ "umip",			CPUID_EAX_0x00000007,	2,	2, },
	{ "pku",			CPUID_EAX_0x00000007,	2,	3, },
	{ "ospke",			CPUID_EAX_0x00000007,	2,	4, },
	{ "avx512_vbmi2",		CPUID_EAX_0x00000007,	2,	6, },
	{ "gfni",			CPUID_EAX_0x00000007,	2,	8, },
	{ "vaes",			CPUID_EAX_0x00000007,	2,	9, },
	{ "vpclmulqdq",			CPUID_EAX_0x00000007,	2,	10, },
	{ "avx512_vnni",		CPUID_EAX_0x00000007,	2,	11, },
	{ "avx512_bitalg",		CPUID_EAX_0x00000007,	2,	12, },
	{ "tme",			CPUID_EAX_0x00000007,	2,	13, },
	{ "avx512_vpopcntdq",		CPUID_EAX_0x00000007,	2,	14, },
	{ "la57",			CPUID_EAX_0x00000007,	2,	16, },
	{ "rdpid",			CPUID_EAX_0x00000007,	2,	22, },
	{ "cldemote",			CPUID_EAX_0x00000007,	2,	25, },
	{ "movdiri",			CPUID_EAX_0x00000007,	2,	27, },
	{ "movdir64b",			CPUID_EAX_0x00000007,	2,	28, },
	//{ "overflow_recov",		CPUID_EAX_0x80000007,	1,	0, },
	//{ "succor",			CPUID_EAX_0x80000007,	1,	1, },
	//{ "smca",			CPUID_EAX_0x80000007,	1,	3, },
	{ "avx512_4vnniw",		CPUID_EAX_0x00000007,	3,	2, },
	{ "avx512_4fmaps",		CPUID_EAX_0x00000007,	3,	3, },
	{ "tsx_force_abort",		CPUID_EAX_0x00000007,	3,	13, },
	{ "pconfig",			CPUID_EAX_0x00000007,	3,	18, },
	{ "spec_ctrl",			CPUID_EAX_0x00000007,	3,	26, },
	{ "intel_stibp",		CPUID_EAX_0x00000007,	3,	27, },
	{ "flush_l1d",			CPUID_EAX_0x00000007,	3,	28, },
	{ "arch_capabilities",		CPUID_EAX_0x00000007,	3,	29, },
	{ "spec_ctrl_ssbd",		CPUID_EAX_0x00000007,	3,	31, },
};
