</$objtype/mkfile

CFLAGS=$CFLAGS

UPDATEFLAGS=

FILES=\
	arena\
	arenas\
	buildbuck\
	clump\
	config\
	conv\
	dcache\
	dump\
	httpd\
	icache\
	ifile\
	index\
	lump\
	lumpcache\
	lumpqueue\
	part\
	score\
	sortientry\
	stats\
	syncarena\
	syncindex0\
	unwhack\
	utils\
	unittoull\
	whack\
	xml\
	zeropart\

LIBCFILES=${FILES:%=%.c}
LIBOFILES=${FILES:%=%.$O}

SLIB=libvs.a.$O

LIB=$SLIB\

HFILES=	dat.h\
	fns.h\
	stdinc.h\

TARG=\
	venti\
	fmtarenas\
	fmtisect\
	fmtindex\
	buildindex\
	checkarenas\
	checkindex\
	clumpstats\
	findscore\
	rdarena\
	wrarena\
	syncindex\
	verifyarena\
	sync\
	read\
	write\
	copy\
	conf\
#	dumparena\

CFILES=${TARG:%=%.c} $LIBCFILES

UPDATE=mkfile\
	mkxml\
	$HFILES\
	$CFILES\

BIN=/$objtype/bin/venti

it:V: all

</sys/src/cmd/mkmany

INC=-I../include -I../lib/venti
CFLAGS=$INC $CFLAGS

acid:	$HFILES icache.c
	$CC $INC -a icache.c > acid || rm acid

xml.c:	mkxml dat.h
	mkxml dat.h > xml.c

$SLIB(%.$O):N: %.$O
$SLIB:	${LIBOFILES:%=$SLIB(%)}
	names = `{echo $newprereq |sed 's/ /\n/g' |sed -n 's/'$SLIB'\(([^)]+)\)/\1/gp'}
	ar vu $SLIB $names
#	rm $names

test:V: all
	slay $O.venti | rc
	rm -f /tmp/arenas /tmp/isect	# zero them
	{syscall seek 1 64000000 0; echo} >>/tmp/arenas
	{syscall seek 1 3000000 0; echo} >>/tmp/isect
	$O.fmtarenas -Z arena. /tmp/arenas
	$O.fmtisect -Z isect0 /tmp/isect
	$O.conf -w /tmp/arenas <{echo '
	mem 1m
	icmem 1m
	bcmem 1m
	index main
	isect /tmp/isect
	arenas /tmp/arenas
	'}
	$O.fmtindex /tmp/arenas
	echo 
	echo
	echo starting venti
	echo
	echo
	$O.venti -c /tmp/arenas -h tcp!127.1!888 -a tcp!127.1!777

$O.conf:D: conf.rc
	{
		echo '#!/bin/rc'
		echo '# THIS FILE IS AUTOMATICALLY GENERATED'
		echo '# FROM /sys/src/cmd/fossil/conf.rc.  DO NOT EDIT.'
		echo 
		sed 1d conf.rc
	} >$target && chmod +x $target
