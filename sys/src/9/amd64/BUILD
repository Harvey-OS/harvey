load("//sys/src/FLAGS", "LIB_COMPILER_FLAGS")

CORE_SRCS = [
    "entry.S",
    "vsvm.c",
    "l64v.S",
    "l64fpu.S",
    "cpuidamd64.S",
    "l64acidt.S",
    "l64idt.S",
    "l64vsyscall.S",
    "acore.c",
    "apic.c",
    "arch.c",
    "archamd64.c",
    "asm.c",
    "backtrace.c",
    "coreboot.c",
    "ctype.c",
    "devarch.c",
    "fpu.c",
    "i8254.c",
    "i8259.c",
    "ioapic.c",
    "main.c",
    "map.c",
    "memory.c",
    "mmu.c",
    "mp.c",
    "msi.c",
    "multiboot.c",
    "physalloc.c",
    "pmcio.c",
    "qmalloc.c",
    "sipi.c",
    "syscall.c",
    "systab.c",
    "tcore.c",
    "trap.c"
]

PORT_SRCS = [
    "//sys/src/9/port/alarm.c",
    "//sys/src/9/port/allocb.c",
    "//sys/src/9/port/cache.c",
    "//sys/src/9/port/chan.c",
    "//sys/src/9/port/cpu_buffer.c",
    "//sys/src/9/port/dev.c",
    "//sys/src/9/port/devcap.c",
    "//sys/src/9/port/devcons.c",
    "//sys/src/9/port/devcoreboot.c",
    "//sys/src/9/port/devdraw.c",
    "//sys/src/9/port/devdup.c",
    "//sys/src/9/port/devenv.c",
    "//sys/src/9/port/devkexec.c",
    "//sys/src/9/port/devkprof.c",
    "//sys/src/9/port/devmnt.c",
    "//sys/src/9/port/devmouse.c",
    "//sys/src/9/port/devpci.c",
    "//sys/src/9/port/devpipe.c",
    "//sys/src/9/port/devpmc.c",
    "//sys/src/9/port/devproc.c",
    "//sys/src/9/port/devregress.c",
    "//sys/src/9/port/devroot.c",
    "//sys/src/9/port/devsd.c",
    "//sys/src/9/port/devsegment.c",
    "//sys/src/9/port/devsrv.c",
    "//sys/src/9/port/devssl.c",
    "//sys/src/9/port/devtls.c",
    "//sys/src/9/port/devtab.c",
    "//sys/src/9/port/devtrace.c",
    "//sys/src/9/port/devuart.c",
    "//sys/src/9/port/devwd.c",
    "//sys/src/9/port/devws.c",
    "//sys/src/9/port/devzp.c",
    "//sys/src/9/port/edf.c",
    "//sys/src/9/port/elf64.c",
    "//sys/src/9/port/ethermii.c",
    "//sys/src/9/port/fault.c",
    "//sys/src/9/port/fortuna.c",
    "//sys/src/9/port/getput.c",
    "//sys/src/9/port/hexdump.c",
    "//sys/src/9/port/image.c",
    "//sys/src/9/port/kdebug.c",
    "//sys/src/9/port/kexec.c",
    "//sys/src/9/port/ipchecksum.c",
    "//sys/src/9/port/mul64fract.c",
    "//sys/src/9/port/netif.c",
    "//sys/src/9/port/page.c",
    "//sys/src/9/port/pager.c",
    "//sys/src/9/port/parse.c",
    "//sys/src/9/port/pgrp.c",
    "//sys/src/9/port/portclock.c",
    "//sys/src/9/port/print.c",
    "//sys/src/9/port/proc.c",
    "//sys/src/9/port/ps.c",
    "//sys/src/9/port/qio.c",
    "//sys/src/9/port/qlock.c",
    "//sys/src/9/port/random.c",
    "//sys/src/9/port/rebootcmd.c",
    "//sys/src/9/port/rmap.c",
    "//sys/src/9/port/sdscsi.c",
    "//sys/src/9/port/segment.c",
    "//sys/src/9/port/sysauth.c",
    "//sys/src/9/port/syscallfmt.c",
    "//sys/src/9/port/sysfile.c",
    "//sys/src/9/port/sysproc.c",
    "//sys/src/9/port/sysseg.c",
    "//sys/src/9/port/syssem.c",
    "//sys/src/9/port/syszio.c",
    "//sys/src/9/port/taslock.c",
    "//sys/src/9/port/tod.c",
    "//sys/src/9/port/usbehci.c",
    "//sys/src/9/port/watermarks.c"
]
IP_SRCS = [
    "//sys/src/9/ip/arp.c",
    "//sys/src/9/ip/chandial.c",
    "//sys/src/9/ip/devip.c",
    "//sys/src/9/ip/ethermedium.c",
    "//sys/src/9/ip/gre.c",
    "//sys/src/9/ip/icmp6.c",
    "//sys/src/9/ip/icmp.c",
    "//sys/src/9/ip/inferno.c",
    "//sys/src/9/ip/ipaux.c",
    "//sys/src/9/ip/ip.c",
    "//sys/src/9/ip/ipifc.c",
    "//sys/src/9/ip/ipmux.c",
    "//sys/src/9/ip/iproute.c",
    "//sys/src/9/ip/ipv6.c",
    "//sys/src/9/ip/loopbackmedium.c",
    "//sys/src/9/ip/netdevmedium.c",
    "//sys/src/9/ip/netlog.c",
    "//sys/src/9/ip/nullmedium.c",
    "//sys/src/9/ip/pktmedium.c",
    "//sys/src/9/ip/ptclbsum.c",
    "//sys/src/9/ip/rudp.c",
    "//sys/src/9/ip/tcp.c",
    "//sys/src/9/ip/udp.c"
]
AMD64_SRCS = [
    "cga.c",
    "devacpi.c",
    "deviig.c",
    "devusb.c",
    "ether8139.c",
    "ether82563.c",
    "amd64cpu.c",
    "mouse.c",
    "cbscreen.c",
    "sdata.c",
    "usbehcipc.c",
    "usbohci.c",
    "usbuhci.c",
    "cbvga.c"
]
# don't want to start with a number
I386_SRCS = [
    "//sys/src/9/386/devether.c",
    "//sys/src/9/386/devrtc.c",
    "//sys/src/9/386/ether8169.c",
    "//sys/src/9/386/ether82557.c",
    "//sys/src/9/386/etherigbe.c",
    "//sys/src/9/386/etherm10g.c",
    "//sys/src/9/386/i8042.c",
    "//sys/src/9/386/pci.c",
    "//sys/src/9/386/sdiahci.c",
    "//sys/src/9/386/uarti8250.c",
    "//sys/src/9/386/uartpci.c",
    "//sys/src/9/386/vgavesa.c"
]

AMD64SRCS = CORE_SRCS + IP_SRCS + I386_SRCS + PORT_SRCS + AMD64_SRCS

#     "bind": "/$ARCH/bin/bind",
#     "boot": "/sys/src/9/boot/bootamd64cpu.elf.out",
#     "cat": "/$ARCH/bin/cat",
#     "date": "/$ARCH/bin/date",
#     "echo": "/$ARCH/bin/echo",
#     "factotum": "/$ARCH/bin/auth/factotum",
#     "fdisk": "/$ARCH/bin/disk/fdisk",
#     "fossil": "/$ARCH/bin/fossil/fossil",
#     "ipconfig": "/$ARCH/bin/ip/ipconfig",
#     "ls": "/$ARCH/bin/ls",
#     "mount": "/$ARCH/bin/mount",
#     "nvram": "/util/nvram",
#     "prep": "/$ARCH/bin/disk/prep",
#     "rc": "/$ARCH/bin/rc",
#     "ps": "/$ARCH/bin/ps",
#     "ed": "/$ARCH/bin/ed",
#     "rcmain": "/rc/lib/rcmain",
#     "screenconsole": "/$ARCH/bin/aux/screenconsole",
#     "realemu": "/$ARCH/bin/aux/realemu",
#     "vga": "/$ARCH/bin/aux/vga",
#     "srv": "/$ARCH/bin/srv",
#     "startdisk": "startdisk",
#     "usbd": "/$ARCH/bin/usb/usbd",
#     "venti": "/$ARCH/bin/venti/venti"


RAMFILES = [
    "//sys/src/cmd:bind",
    "//sys/src/cmd:cat",
    "//sys/src/cmd:date",
    "//sys/src/cmd:echo",
    "//sys/src/cmd/auth/factotum:factotum",
    "//sys/src/cmd/disk/9660:dump9660",
    "//sys/src/cmd/disk/prep:fdisk",
    "//sys/src/cmd/disk/prep:prep",
    "//sys/src/cmd/disk:exsort",
    "//sys/src/cmd/disk:format",
    "//sys/src/cmd/disk:mbr",
    "//sys/src/cmd/disk:mkext",
    "//sys/src/cmd/disk:mkfs",
    "//sys/src/cmd/disk:partfs",
    "//sys/src/cmd/venti:copy",
    "//sys/src/cmd/venti:read",
    "//sys/src/cmd/venti:ro",
    "//sys/src/cmd/venti:sync",
    "//sys/src/cmd/venti:write",
    "//sys/src/cmd/venti:devnull",
    "//sys/src/cmd/venti:mkroot",
    "//sys/src/cmd/venti:randtest",
    "//sys/src/cmd/venti:readlist",
    "//sys/src/cmd/venti:root",
]

group(
    name="cmds",
    deps=RAMFILES
)

mk_sys(
    name="error",
    mode="error.h",
    arch="amd64",
    sysconf="//sys/src/sysconf.json",
)

mk_sys(
    name="sys",
    mode="sys.h",
    arch="amd64",
    sysconf="//sys/src/sysconf.json",
)

mk_sys(
    name="systab",
    mode="systab.c",
    arch="amd64",
    sysconf="//sys/src/sysconf.json",
)

mk_sys(
    name="errstr",
    mode="errstr.h",
    arch="amd64",
    sysconf="//sys/src/sysconf.json",
)

kernel(
    name="amd64cpu",
    copts=[
        "-mcmodel=kernel",
        "-O0",
        "-static",
        "-fplan9-extensions",
        "-mno-red-zone",
        "-ffreestanding",
        "-fno-builtin",
        "-DKERNDATE=1433623937",
        "-g",
        "-fvar-tracking",
        "-fvar-tracking-assignments",
        "-Wall",
        "-W",
        "-Wno-sign-compare",
        "-Wno-missing-field-initializers",
        "-Wno-unused-parameter",
        "-Wno-missing-braces",
        "-Wno-parentheses",
        "-Wno-unknown-pragmas",
        "-Werror",
        "-fasm",
    ],
    srcs=AMD64SRCS,
    includes=[
        "//sys/include",
        "//amd64/include",
        "//sys/src/9/amd64",
    ],
    deps=[
        ":error",
        ":errstr",
        ":systab",
        ":sys",
        "//sys/src/9/boot:amd64cpu",
        ":inith",
        "//sys/src/libmemdraw:libkmemdraw",
        "//sys/src/libdraw:libkdraw",
        "//sys/src/libc:libkc",
        "//sys/src/libip:libkip",
        "//sys/src/libsec:libksec",
    ],
    ld="kernel.ld",
    linkopts=[
        "-z",
        "max-page-size=0x1000",
        "-nostdlib",
        "-g",
        "-T",
    ]
)

elf_to_c(
    name="inith",
    deps=[
        ":init",
    ],
    elf="bin/init",
)

cc_binary(
    name="init",
    copts=[
        "-c",
        "-g",
        "-Wall",
        "-Wno-missing-braces",
        "-Wno-parentheses",
        "-Wno-unknown-pragmas",
        "-O0",
        "-static",
        "-fplan9-extensions",
        "-mno-red-zone",
        "-ffreestanding",
        "-fno-builtin",
        "-mcmodel=small",
    ],
    deps=[
        "//sys/src/libc:libc"
    ],
    includes=[
        "//sys/include",
        "//amd64/include",
    ],
    linkopts=[
        "-e_main",
        "-static",
        "-Ttext=0x200020",
    ],
    srcs=[
        "init9.c",
        "//sys/src/9/port/initcode.c",
    ]
)
