#!/boot/rc -m /boot/rcmain

cpuserver=no
cd /boot
cp '#r/rtc' '#c/time'
bind -a '#I' /net
bind -a '#l0' /net
bind -a '#S' /dev
bind '#p' /proc
bind '#d' /fd
bind -a /boot /
ipconfig loopback /dev/null 127.1
if(~ $cpuserver yes){
	factotum -sfactotum -S
}
if not{
	factotum -sfactotum -u
	# add a key so mount and fossil can authenticate each other
	# remove this key once factotum is initialized with other keys
	factotum -g 'proto=p9sk1 user=rsc dom=localhost !password=localhost'
}
venti -c venti.conf -B 8m -C 8m -h tcp!127.1!8000 -I 8m -w -a tcp!127.1!17034 &
sleep 10
venti=tcp!127.0.0.1!17034
fossil -c '. flproto'
mount -c /srv/boot /root
bind -ac /root /
rootdir=/root
rootspec=''
if(~ $cpuserver yes)
	/386/init -c
if not
	/386/init -t
exec ./rc -m/boot/rcmain -i
